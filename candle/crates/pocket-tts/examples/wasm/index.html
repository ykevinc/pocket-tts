<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket TTS - WebAssembly Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent: #f43f5e;
            --accent-hover: #e11d48;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            line-height: 1.5;
        }

        .container {
            max-width: 1100px;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
            background: linear-gradient(to right, #fb7185, #f43f5e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.025em;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.5);
            color: var(--text);
            font-size: 1rem;
            resize: none;
            min-height: 180px;
            font-family: inherit;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            border: 1px solid var(--card-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status.loading {
            background: rgba(234, 179, 8, 0.1);
            color: #fde047;
            border: 1px solid rgba(234, 179, 8, 0.2);
        }

        .status.success {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        audio {
            width: 100%;
            height: 40px;
            margin-top: 1rem;
            border-radius: 8px;
            filter: invert(100%) hue-rotate(180deg) brightness(1.5);
        }

        #waveform {
            width: 100%;
            height: 100px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            margin-top: 1rem;
            border: 1px solid var(--card-border);
        }

        /* Sidebar Panels */
        .panel {
            margin-bottom: 1rem;
        }

        .panel-header {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        select,
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .voice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .upload-compact {
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px dashed var(--card-border);
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .upload-compact label {
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
        }

        .upload-compact input {
            font-size: 0.7rem;
        }

        .badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 100px;
            font-weight: 600;
        }

        .badge-hf {
            background: #eab308;
            color: #000;
        }

        .badge-local {
            background: #22c55e;
            color: #fff;
        }

        .collapsible-trigger {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-top: 1px solid var(--card-border);
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .collapsible-content {
            display: none;
            padding-top: 1rem;
        }

        .collapsible-content.open {
            display: block;
        }

        .voice-state-indicator {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            padding: 0.4rem 0.6rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            color: var(--text-muted);
        }

        .voice-state-active {
            color: #4ade80;
            font-weight: 600;
        }

        .voice-cloning-disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: saturate(0);
        }

        footer {
            margin-top: 3rem;
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üé§ Pocket TTS</h1>
            <p class="subtitle">Next-gen Text-to-Speech via WebAssembly</p>
        </header>

        <div class="dashboard">
            <!-- Left Column: Main Generation -->
            <main class="card">
                <h3><span>‚ú®</span> Synthesis</h3>
                <label for="text-input">Text to speak</label>
                <textarea id="text-input" placeholder="Enter something incredible for me to say..."></textarea>

                <div class="controls">
                    <button id="generate-btn" class="btn btn-primary" disabled>
                        <span>üîä</span> Generate Speech
                    </button>
                    <button id="stop-btn" class="btn btn-secondary" disabled>
                        <span>‚èπ</span> Stop
                    </button>
                </div>

                <div id="status" class="status loading" style="display: none;">
                    <div class="spinner"></div>
                    <span id="status-text">Loading engine...</span>
                </div>

                <canvas id="waveform" style="display: none;"></canvas>
                <audio id="audio-player" controls style="display: none;"></audio>

                <!-- Status Legend -->
                <div
                    style="display: flex; gap: 1rem; margin-top: 1.5rem; font-size: 0.7rem; color: var(--text-muted); opacity: 0.6;">
                    <span><span class="badge badge-local">Local</span> Static assets from /pkg</span>
                    <span><span class="badge badge-hf">HF</span> Fetched via Hugging Face Hub</span>
                </div>
            </main>

            <!-- Right Column: Voices & Settings -->
            <aside class="card" id="voice-cloning-card">
                <div class="panel">
                    <div class="panel-header">
                        <span>üéôÔ∏è Voice Select</span>
                    </div>
                    <label>Predefined Presets</label>
                    <select id="voice-preset" disabled>
                        <option value="">-- Choose a character --</option>
                        <option value="alba">Alba (Calm)</option>
                        <option value="marius">Marius (Deep)</option>
                        <option value="javert">Javert (Firm)</option>
                        <option value="jean">Jean (Warm)</option>
                        <option value="fantine">Fantine (Soft)</option>
                        <option value="cosette">Cosette (Bright)</option>
                        <option value="eponine">Eponine (Raspy)</option>
                        <option value="azelma">Azelma (Bold)</option>
                    </select>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span>üß¨ Cloning</span>
                    </div>
                    <label>Clone from WAV (5-10s)</label>
                    <input type="file" id="voice-upload" accept=".wav" disabled
                        style="padding: 0; border: none; background: transparent; font-size: 0.8rem;">

                    <label style="margin-top: 0.75rem;">Voice Embedding (.safetensors)</label>
                    <input type="file" id="voice-safetensors" accept=".safetensors" disabled
                        style="padding: 0; border: none; background: transparent; font-size: 0.8rem;">
                </div>

                <div id="voice-status" class="voice-state-indicator">
                    Initialize model to unlock voices
                </div>

                <div class="collapsible-trigger" id="settings-trigger">
                    <span>‚öôÔ∏è Advanced Settings</span>
                    <span id="settings-chevron">‚ñº</span>
                </div>

                <div class="collapsible-content" id="settings-panel">
                    <label>HF Repository</label>
                    <input type="text" id="hf-repo" value="kyutai/pocket-tts">

                    <label>HF Access Token (Gated)</label>
                    <input type="password" id="hf-token" placeholder="hf_...">

                    <div class="upload-compact" id="upload-zone" style="display: block;">
                        <div class="panel-header" style="margin-bottom: 0.5rem; font-size: 0.7rem;">Manual File
                            Overrides</div>
                        <div style="display: grid; gap: 0.5rem;">
                            <div>
                                <label>Model Weights</label>
                                <input type="file" id="weights-upload" accept=".safetensors">
                            </div>
                            <div>
                                <label>Tokenizer JSON</label>
                                <input type="file" id="tokenizer-upload" accept=".json">
                            </div>
                            <div>
                                <label>Config YAML</label>
                                <input type="file" id="config-upload" accept=".yaml,.yml">
                            </div>
                        </div>
                        <button id="manual-load-btn" class="btn btn-secondary"
                            style="width: 100%; font-size: 0.75rem; margin-top: 0.75rem; padding: 0.4rem;">
                            Load Overrides
                        </button>
                    </div>

                    <button id="retry-auto-load" class="btn btn-secondary"
                        style="width: 100%; margin-top: 1rem; font-size: 0.8rem; padding: 0.5rem;">
                        üîÑ Re-sync with HF Hub
                    </button>

                    <input type="hidden" id="file-weights" value="tts_b6369a24.safetensors">
                    <input type="hidden" id="file-config" value="embedded">
                    <input type="hidden" id="file-tokenizer" value="tokenizer.json">
                </div>
            </aside>
        </div>

        <footer>
            <p>Pocket TTS ü¶Ä Pure Rust & WASM Machine Learning</p>
            <p style="margin-top: 0.5rem; opacity: 0.5;">No servers. No data tracking. Pure privacy.</p>
        </footer>
    </div>

    <script type="module">
        import init, { WasmTTSModel } from '../../pkg/pocket_tts.js';

        const textInput = document.getElementById('text-input');
        const generateBtn = document.getElementById('generate-btn');
        const stopBtn = document.getElementById('stop-btn');
        const audioPlayer = document.getElementById('audio-player');
        const waveformCanvas = document.getElementById('waveform');
        const uploadZone = document.getElementById('upload-zone');
        const manualLoadBtn = document.getElementById('manual-load-btn');
        const configInput = document.getElementById('config-upload');
        const weightsInput = document.getElementById('weights-upload');
        const tokenizerInput = document.getElementById('tokenizer-upload');
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');

        const DEFAULT_CONFIG_YAML = `
flow_lm:
  dtype: float32
  flow:
    depth: 6
    dim: 512
  transformer:
    d_model: 1024
    hidden_scale: 4
    max_period: 10000
    num_heads: 16
    num_layers: 6
  lookup_table:
    dim: 1024
    n_bins: 4000
    tokenizer: sentencepiece
    tokenizer_path: hf://kyutai/pocket-tts-without-voice-cloning/tokenizer.model@d4fdd22ae8c8e1cb3634e150ebeff1dab2d16df3

mimi:
  dtype: float32
  sample_rate: 24000
  channels: 1
  frame_rate: 12.5
  seanet:
    dimension: 512
    channels: 1
    n_filters: 64
    n_residual_layers: 1
    ratios: [6, 5, 4]
    kernel_size: 7
    residual_kernel_size: 3
    last_kernel_size: 3
    dilation_base: 2
    pad_mode: constant
    compress: 2
  transformer:
    d_model: 512
    num_heads: 8
    num_layers: 2
    layer_scale: 0.01
    context: 250
    dim_feedforward: 2048
    input_dimension: 512
    output_dimensions: [512]
  quantizer:
    dimension: 32
    output_dimension: 512
`;

        let tts = null;
        let audioContext = null;

        function showStatus(message, type = 'loading') {
            statusDiv.style.display = 'flex';
            statusDiv.className = `status ${type}`;
            statusText.innerHTML = message;
            const spinner = statusDiv.querySelector('.spinner');
            if (spinner) spinner.style.display = type === 'loading' ? 'block' : 'none';
        }

        const hideStatus = () => statusDiv.style.display = 'none';

        async function initializeModel() {
            try {
                showStatus('Initializing Engine...', 'loading');
                await init();
                tts = new WasmTTSModel();

                showStatus('Fetching model weights...', 'loading');
                const fileWeights = document.getElementById('file-weights').value;
                let source = "local";

                const fetchWithFallback = async (filename) => {
                    const repo = document.getElementById('hf-repo').value.trim();
                    const token = document.getElementById('hf-token').value.trim();
                    try {
                        const res = await fetch(`/${filename}`);
                        if (!res.ok) throw new Error("Local 404");
                        return new Uint8Array(await res.arrayBuffer());
                    } catch (e) {
                        source = "HF";
                        const hfUrl = `https://huggingface.co/${repo}/resolve/main/${filename}`;
                        const headers = {};
                        if (token) headers["Authorization"] = `Bearer ${token}`;
                        const hfRes = await fetch(hfUrl, { headers });
                        if (!hfRes.ok) {
                            if (hfRes.status === 401) throw new Error("Auth Required (Gated repo)");
                            throw new Error(`Asset not found (${hfRes.status})`);
                        }
                        return new Uint8Array(await hfRes.arrayBuffer());
                    }
                };

                const weights = await fetchWithFallback(fileWeights);
                const configBytes = new TextEncoder().encode(DEFAULT_CONFIG_YAML);
                const tokenizer = new Uint8Array(0);

                tts.load_from_buffer(configBytes, weights, tokenizer);

                const badge = source === "HF" ? '<span class="badge badge-hf">HF Hub</span>' : '<span class="badge badge-local">Local</span>';
                showStatus(`Engine Online ${badge}`, 'success');

                generateBtn.disabled = false;
                document.getElementById('voice-cloning-card').classList.remove('voice-cloning-disabled');
                ['voice-upload', 'voice-safetensors', 'voice-preset'].forEach(id => document.getElementById(id).disabled = false);
                document.getElementById('voice-status').innerHTML = 'Select a voice to begin';

                setTimeout(hideStatus, 2000);
            } catch (e) {
                console.error(e);
                showStatus(`Setup Failed: ${e.message}`, 'error');
                document.getElementById('settings-panel').classList.add('open');
            }
        }

        async function generateSpeech() {
            const text = textInput.value.trim();
            if (!text) { showStatus('Enter text, please', 'error'); return; }
            if (!tts?.is_ready()) { showStatus('Engine offline', 'error'); return; }

            try {
                generateBtn.disabled = true;
                stopBtn.disabled = false;
                showStatus('Synthesizing...', 'loading');

                const wavDataUrl = tts.generate_wav_base64(text);
                audioPlayer.src = wavDataUrl;
                audioPlayer.style.display = 'block';
                audioPlayer.play();

                const samples = tts.generate(text);
                drawWaveform(samples);

                showStatus('Done!', 'success');
                setTimeout(hideStatus, 1500);
            } catch (e) {
                showStatus(`Failed: ${e.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }

        function drawWaveform(samples) {
            waveformCanvas.style.display = 'block';
            const ctx = waveformCanvas.getContext('2d');
            const width = waveformCanvas.width = waveformCanvas.offsetWidth * 2;
            const height = waveformCanvas.height = waveformCanvas.offsetHeight * 2;

            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = '#f43f5e';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.beginPath();

            const step = Math.ceil(samples.length / width);
            const mid = height / 2;

            for (let i = 0; i < width; i++) {
                const idx = i * step;
                const val = samples[idx] || 0;
                const y = mid + val * mid * 0.9;
                if (i === 0) ctx.moveTo(i, y); else ctx.lineTo(i, y);
            }
            ctx.stroke();
        }

        const readFile = (input) => new Promise((resolve, reject) => {
            if (!input.files?.[0]) return reject(new Error('Choose a file'));
            const reader = new FileReader();
            reader.onload = () => resolve(new Uint8Array(reader.result));
            reader.onerror = reject;
            reader.readAsArrayBuffer(input.files[0]);
        });

        manualLoadBtn.addEventListener('click', async () => {
            try {
                showStatus('Syncing custom assets...', 'loading');
                const config = await readFile(configInput);
                const weights = await readFile(weightsInput);
                const tokenizer = tokenizerInput.files?.[0] ? await readFile(tokenizerInput) : new Uint8Array(0);
                tts.load_from_buffer(config, weights, tokenizer);
                showStatus('Ready!', 'success');
                generateBtn.disabled = false;
                setTimeout(hideStatus, 2000);
            } catch (e) { showStatus(e.message, 'error'); }
        });

        document.getElementById('settings-trigger').addEventListener('click', () => {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('open');
            document.getElementById('settings-chevron').textContent = panel.classList.contains('open') ? '‚ñ≤' : '‚ñº';
        });

        document.getElementById('voice-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                showStatus(`Cloning ${file.name}...`, 'loading');
                const bytes = await readFile(e.target);
                tts.load_voice_from_buffer(bytes);
                document.getElementById('voice-status').innerHTML = `Active: <span class="voice-state-active">${file.name}</span>`;
                showStatus('Clone Successful', 'success');
                setTimeout(hideStatus, 2000);
            } catch (e) { showStatus(`Cloning Failed: ${e.message}`, 'error'); }
        });

        document.getElementById('voice-safetensors').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                showStatus(`Injecting embedding...`, 'loading');
                const bytes = await readFile(e.target);
                tts.load_voice_from_safetensors(bytes);
                document.getElementById('voice-status').innerHTML = `Active: <span class="voice-state-active">${file.name}</span>`;
                showStatus('Embedding Loaded', 'success');
                setTimeout(hideStatus, 2000);
            } catch (e) { showStatus(e.message, 'error'); }
        });

        document.getElementById('voice-preset').addEventListener('change', async (e) => {
            const voice = e.target.value;
            if (!voice) return;
            try {
                showStatus(`Fetching ${voice}...`, 'loading');
                const repo = document.getElementById('hf-repo').value.trim();
                const token = document.getElementById('hf-token').value.trim();
                const hfUrl = `https://huggingface.co/${repo}/resolve/main/embeddings/${voice}.safetensors`;
                const headers = {};
                if (token) headers["Authorization"] = `Bearer ${token}`;
                const res = await fetch(hfUrl, { headers });
                if (!res.ok) throw new Error(`Fetch failed (${res.status})`);
                const bytes = new Uint8Array(await res.arrayBuffer());
                tts.load_voice_from_safetensors(bytes);
                document.getElementById('voice-status').innerHTML = `Active Profile: <span class="voice-state-active">${voice.toUpperCase()}</span>`;
                showStatus('Voice Synced', 'success');
                setTimeout(hideStatus, 2000);
            } catch (e) { showStatus(`Voice Sync Error: ${e.message}`, 'error'); }
        });

        generateBtn.addEventListener('click', generateSpeech);
        stopBtn.addEventListener('click', () => {
            if (audioContext) { audioContext.close(); audioContext = null; }
            stopBtn.disabled = true;
            generateBtn.disabled = false;
        });

        document.getElementById('retry-auto-load').addEventListener('click', initializeModel);

        initializeModel();
    </script>
</body>

</html>